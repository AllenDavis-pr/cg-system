{% extends "base_item_analysis.html" %}

{% block title %}Buying Analysis{% endblock %}

{% block header_title %}BUYING ANALYSIS{% endblock %}

{% block panel_title %}INPUT PANEL{% endblock %}

{% block input_panel_content %}
{% csrf_token %}
<div class="input-row">
  <div class="input-group" style="flex: 2;">
    <label class="input-label">Item Name</label>
    <input type="text" id="item-name" class="input-field" placeholder="iPhone 14" required>
  </div>
</div>

<div class="input-group">
  <label class="input-label">Description</label>
  <textarea id="description" class="input-field description-field" placeholder="Good condition, minor scratches, original box included..." required></textarea>
</div>

<div class="input-group">
  <label class="input-label">Minimum Margin (%)</label>
  <input type="number" id="minimum-margin" class="input-field" placeholder="37.5" value="37.5" step="0.1" min="0" max="100">
</div>

<button type="button" id="analyze-btn" class="analyze-button" onclick="analyzeItem()">
  <span id="button-text">ANALYZE PRICING</span>
  <span id="button-spinner" class="loading-spinner hidden"></span>
</button>
{% endblock %}

{% block extra_style %}
{{ block.super }}
.price-panels-container {
  display: flex;
  gap: 20px;
  align-items: stretch;
  margin-bottom: 20px;
}

.price-panel {
  flex: 1;
  background-color: #1a1a1a;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 20px;
}

.price-panel-label {
  font-size: 16px;
  color: #888;
  text-transform: uppercase;
  margin-bottom: 8px;
  font-weight: 600;
  text-align: center;
}

.price-panel-value {
  font-size: 32px;
  font-weight: 700;
  color: #fff;
  text-align: center
}

.buying-range-display {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  width: 100%;
  align-items: center;
  justify-content: center; 
}

.buying-price-item {
  display: flex;
  flex-direction: column;
  align-items: center;

}


.buying-price-separator {
  font-size: 24px;
  color: #666;
}


.buying-price-value {
  font-size: 28px;
  font-weight: 700;
  color: #4ade80;
}

.buying-price-sublabel {
  font-size: 10px;
  color: #666;
  text-transform: uppercase;
  margin-top: 4px;
}

.price-separator {
  width: 1px;
  background-color: #333;
  align-self: stretch;
}

.reasoning-panel {
  background-color: #1a1a1a;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
}

.reasoning-panel-label {
  font-size: 11px;
  color: #888;
  text-transform: uppercase;
  margin-bottom: 12px;
  font-weight: 600;
}

.reasoning-panel-text {
  color: #ccc;
  line-height: 1.6;
  font-size: 14px;
}

/* Hide the entire analysis section by default */
.analysis-results {
  display: none;
}

/* Hide the default analysis section elements */
.recommended-price {
  display: none;
}

.reasoning {
  display: none;
}
{% endblock %}

{% block buying_price_panel %}
<div class="analysis-results" id="analysis-results">
  <div class="price-panels-container">
    <div class="price-panel">
      <div class="price-panel-label">Recommended Selling Price</div>
      <div class="price-panel-value" id="recommended-price-display">£0.00</div>
    </div>

    <div class="price-separator"></div>

    <div class="price-panel">
      <div class="price-panel-label">Recommended Buying Range</div>
      <div class="buying-range-display">
          <div class="buying-price-item">
              <div class="buying-price-value" id="buying-price-min">£0.00</div>
              <div class="buying-price-sublabel">Min</div>
          </div>

          <div class="buying-price-separator">—</div>

          <div class="buying-price-item">
              <div class="buying-price-value" id="buying-price-max">£0.00</div>
              <div class="buying-price-sublabel">Max</div>
          </div>
      </div>
    </div>
  </div>

  <div class="reasoning-panel">
    <div class="reasoning-panel-label">Reasoning</div>
    <div class="reasoning-panel-text" id="reasoning-text-content">
      Analysis will appear here...
    </div>
  </div>
</div>
{% endblock %}

{% block modals %}
{% endblock %}

{% block extra_script %}
const modal = document.getElementById('list-modal');
const modalClose = document.getElementById('modal-close');
const modalItemName = document.getElementById('modal-item-name');
const modalDescription = document.getElementById('modal-description');
const modalPrice = document.getElementById('modal-price');
const confirmListBtn = document.getElementById('confirm-list-btn');
const modalSubmitBtn = document.getElementById('modal-submit');

modal.classList.add('hidden');
modal.style.display = 'none';

confirmListBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    modal.classList.remove('hidden');

    modalItemName.value = document.getElementById('item-name').value;
    modalDescription.value = document.getElementById('description').value;
    modalPrice.value = document.getElementById('recommended-price-display').textContent.replace(/[^0-9.]+/g, '');
    document.getElementById('modal-serial-number').value = document.getElementById('serial-number').value;
});

modalClose.addEventListener('click', () => {
    modal.style.display = 'none';
    modal.classList.add('hidden');
});

window.addEventListener('click', (e) => {
    if (e.target === modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
    }
});

modalSubmitBtn.addEventListener('click', async function() {
    modalSubmitBtn.disabled = true;
    modalSubmitBtn.textContent = 'Launching Automation...';

    try {
        const response = await fetch('/launch-playwright-listing/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                item_name: modalItemName.value,
                description: modalDescription.value,
                price: modalPrice.value,
                serial_number: document.getElementById('modal-serial-number').value
            })
        });

        const result = await response.json();

        if (result.success) {
            setTimeout(() => {
                modalSubmitBtn.textContent = '✅ Automation Complete!';
                modalSubmitBtn.disabled = false;
            }, 2000);
        } else {
            alert(`Automation failed: ${result.error}`);
            modalSubmitBtn.disabled = false;
            modalSubmitBtn.textContent = 'List Item';
        }
    } catch (error) {
        console.error('Error launching automation:', error);
        alert('Failed to launch automation. Please try again.');
        modalSubmitBtn.disabled = false;
        modalSubmitBtn.textContent = 'List Item';
    }
});

function calculateBuyingRange(sellingPrice, marginPercent) {
    const numPrice = parseFloat(sellingPrice.replace(/[^0-9.]/g, ''));
    const margin = parseFloat(marginPercent) / 100;
    
    // Calculate max buying price based on margin
    // If margin is 37.5%, then buying price = selling price / (1 + 0.375)
    const maxBuying = numPrice / (1 + margin);
    
    // Min is 10% less than max
    const minBuying = maxBuying * 0.9;
    
    return {
        min: `£${minBuying.toFixed(2)}`,
        max: `£${maxBuying.toFixed(2)}`
    };
}

function displayAnalysis(reasoning, suggestedPrice) {
    const analysisResults = document.getElementById('analysis-results');
    const recommendedPrice = document.getElementById('recommended-price');
    const recommendedPriceDisplay = document.getElementById('recommended-price-display');
    const buyingPriceMin = document.getElementById('buying-price-min');
    const buyingPriceMax = document.getElementById('buying-price-max');
    const reasoningText = document.getElementById('reasoning-text');
    const reasoningTextContent = document.getElementById('reasoning-text-content');
    const analysisTime = document.getElementById('analysis-time');

    // Show the analysis results section
    analysisResults.style.display = 'block';
    
    // Update both price displays (original and new panel)
    recommendedPrice.textContent = suggestedPrice;
    recommendedPriceDisplay.textContent = suggestedPrice;
    
    // Update both reasoning displays
    if (reasoningText) reasoningText.innerHTML = reasoning;
    if (reasoningTextContent) reasoningTextContent.innerHTML = reasoning;

    // Calculate buying range based on minimum margin
    const marginPercent = document.getElementById('minimum-margin').value || 37.5;
    const buyingRange = calculateBuyingRange(suggestedPrice, marginPercent);
    
    buyingPriceMin.textContent = buyingRange.min;
    buyingPriceMax.textContent = buyingRange.max;

    const competitorNumber = document.getElementById('competitor-number');
    const competitorCount = competitorNumber ? parseInt(competitorNumber.textContent) : 0;

    analysisTime.textContent = 'just now';

    analysisResults.scrollIntoView({ behavior: 'smooth' });
}

// Add event listener to recalculate when margin changes
document.addEventListener('DOMContentLoaded', function() {
    const marginInput = document.getElementById('minimum-margin');
    
    marginInput.addEventListener('input', function() {
        // If analysis has been run, recalculate buying range
        const recommendedPrice = document.getElementById('recommended-price-display');
        const analysisResults = document.getElementById('analysis-results');
        
        if (analysisResults.style.display === 'block' && recommendedPrice && recommendedPrice.textContent && recommendedPrice.textContent !== '£0.00') {
            const marginPercent = this.value || 37.5;
            const buyingRange = calculateBuyingRange(recommendedPrice.textContent, marginPercent);
            
            document.getElementById('buying-price-min').textContent = buyingRange.min;
            document.getElementById('buying-price-max').textContent = buyingRange.max;
        }
    });
});

async function analyzeItem() {
    const itemName = document.getElementById('item-name').value.trim();
    const description = document.getElementById('description').value.trim();
    const analyzeBtn = document.getElementById('analyze-btn');
    const buttonText = document.getElementById('button-text');
    const buttonSpinner = document.getElementById('button-spinner');

    if (!itemName || !description) {
        return;
    }

    analyzeBtn.disabled = true;
    buttonText.classList.add('hidden');
    buttonSpinner.classList.remove('hidden');

    try {
        const response = await fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                item_name: itemName,
                description: description
            })
        });

        const data = await response.json();

        if (data.success) {
            updateCompetitorData(data.competitor_data || '', data.competitor_count || 0);
            displayAnalysis(data.reasoning, data.suggested_price);
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Network error. Please try again.');
    } finally {
        analyzeBtn.disabled = false;
        buttonText.classList.remove('hidden');
        buttonSpinner.classList.add('hidden');
    }
}

document.getElementById('description').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        analyzeItem();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const prefilledItem = "{{ prefilled_item|escapejs }}";
    const prefilledMarketItem = "{{ prefilled_market_item|escapejs }}";
    const prefilledDescription = "{{ prefilled_description|escapejs }}";
    const prefilledSerial = "{{ prefilled_serial|escapejs }}";

    if (prefilledItem) {
        document.getElementById('item-name').value = prefilledItem;
    } else if (prefilledMarketItem) {
        document.getElementById('item-name').value = prefilledMarketItem;
    }

    if (prefilledSerial) {
        document.getElementById('serial-number').value = prefilledSerial;
    }

    if (prefilledDescription) {
        document.getElementById('description').value = prefilledDescription;
    }

    if ((prefilledItem || prefilledMarketItem) && prefilledDescription) {
        setTimeout(() => {
            analyzeItem();
        }, 500);
    }
});
{% endblock %}